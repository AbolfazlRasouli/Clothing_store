{% extends '_base.html' %}
{% load static %}
{#{% load crispy_forms_tags %}#}


{% block content %}


    <!-- Breadcumbs start -->
    <div class="e-breadcumb-wrap text-center">
        <h2 class="e-breadcumb-title">تک محصول</h2>
        <ul class="e-breadcumb-kist">
            <li><a href="index.html">صفحه اصلی </a></li>
            <li><a href="javascript:void(0);">لباس مردانه </a></li>
            <li><a href="javascript:void(0);">کت </a></li>
            <li><a href="javascript:void(0);">مشکی خاکستری کلاه دار </a></li>
        </ul>
    </div>



    <!-- Product Details start -->
    <section class="e-prodetails-wrap ">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="pd-gallery-wrap">
                        <div class="pd-thumb-box">
                            <ul class="pd-thumb-list">
                                {% for image in images %}
                                    <li class="active">
                                        <img src="{{ image.image.url }}" alt="product-img"
                                             data-source="assets/images/index1/pro-single01.jpg" class="pro_thumb">
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="pd-img-wrap">
                            <div class="pd-img text-center">
                                <img src="{{ details.image.url }}" alt="product-img">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="prodetails-info">
                        <div class="pd-infotop">
                            <h2 class="pd-title">{{ details.name }}</h2>

                            <ul class="pd-price-wrap">


                                {% if details.discount %}
                                    <li><span class="pd-price-ttile"
                                              style="text-decoration: line-through; color: red;">{{ details.price }} تومان </span>
                                    </li>
                                    <li><span class="pd-price-off">{{ details.discount.percent }}% </span></li>



                                    <li class="na-price">{{ details.calculate_discounted_price|floatformat:"2"|floatformat:"0" }}
                                        تومان
                                    </li>
                                {% else %}
                                    <li><span class="pd-price-ttile"
                                    >{{ details.price }} تومان </span>
                                    </li>
                                {% endif %}


                            </ul>
                        </div>
                        <div class="pd-info-bottom">
                            <ul class="info-bottom-list">

                                <li>
                                    <div class="ib-list-left">
                                        <span>سایز های موجود</span>
                                    </div>
                                    <div class="ib-list-right">
                                        <ul class="d-flex">

                                            {% for size in sizes %}
                                                <li style="margin: 0 5px;">
                                                    {#   <input type="radio" id="size_{{ size }}" name="selected_size"#}
                                                    {#  value="{{ size }}">#}
                                                    <input type="radio" id="size_{{ forloop.counter0 }}"
                                                           name="selected_size"
                                                           value="{{ size }}">
                                                    <label for="size_{{ size }}">{{ size }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                </li>


                                <li>
                                    <div class="ib-list-left">
                                        <span>رنگ های موجود</span>
                                    </div>
                                    <div class="ib-list-right">
                                        <div id="size_color_dict" style="display: none; ">
                                            {{ colors }}</div>

                                        <ul style="display: flex; align-items: center;" id="color">
                                            {#                                            {% for color in colors %}#}
                                            {#                                                <li style="width: 50px; height: 50px; padding: 5px;"#}
                                            {#                                                    onclick="selectColor(this, '{{ color }}')">#}
                                            {#                                                    <div style=" width:90%;#}
                                            {#                                                                                             height:90%; border-radius: 5px;#}
                                            {#                                                                                             box-sizing: border-box;  margin:auto;#}
                                            {#                                                                                              background-color: {{ color }}"></div>#}
                                            {#                                                </li>#}
                                            {##}
                                            {#                                            {% endfor %}#}
                                        </ul>

                                    </div>
                                </li>


                                <li>

                                    <div class="ib-list-right">
                                        <ul class="pd-qua-wrap">
                                            <li>
                                                <div class="quantity-box">
                                                    <input type="text" value="1" class="quantity_input"
                                                           style="width: 50px; border: 0">
                                                    <span class="quantity-minus pa-sub quantity-icon"> - </span>
                                                    <span class="quantity-plus  pa-add quantity-icon"> + </span>
                                                    <div class="clearfix"></div>
                                                </div>
                                            </li>
                                            <li>
                                                <a href="#" class="e-btn pd-addcart" onclick="addToCart(this)">افزودن به
                                                    سبد </a>
                                            </li>
                                            <li>
                                                <a href="wishlist.html" class="e-btn light pd-heart">
                                                    <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            xmlns:xlink="http://www.w3.org/1999/xlink"
                                                            width="17px" height="16px">
                                                        <path fill-rule="evenodd" fill="rgb(90, 106, 137)"
                                                              d="M15.616,1.939 C14.768,0.972 13.603,0.440 12.337,0.440 C11.387,0.440 10.516,0.755 9.751,1.377 C9.456,1.616 9.182,1.898 8.933,2.217 C8.683,1.898 8.409,1.616 8.115,1.377 C7.350,0.755 6.480,0.440 5.529,0.440 C4.262,0.440 3.098,0.972 2.249,1.939 C1.419,2.886 0.962,4.175 0.962,5.570 C0.962,7.002 1.465,8.308 2.547,9.681 C3.494,10.880 4.842,12.088 6.411,13.493 C6.940,13.967 7.540,14.504 8.163,15.077 C8.375,15.272 8.649,15.380 8.933,15.380 C9.218,15.380 9.491,15.272 9.703,15.077 C10.269,14.555 10.818,14.063 11.311,13.622 L11.458,13.490 C13.019,12.092 14.367,10.886 15.318,9.681 C16.400,8.309 16.904,7.003 16.904,5.570 C16.904,4.175 16.446,2.886 15.616,1.939 ZM5.529,1.905 C6.154,1.905 6.729,2.115 7.237,2.528 C7.702,2.906 8.028,3.387 8.219,3.724 C8.522,4.253 9.346,4.252 9.646,3.723 C9.838,3.387 10.163,2.906 10.628,2.528 C11.137,2.115 11.712,1.905 12.337,1.905 C13.198,1.905 13.989,2.266 14.566,2.923 C15.160,3.599 15.486,4.540 15.486,5.570 C15.486,6.662 15.095,7.644 14.220,8.754 C13.352,9.855 12.049,11.023 10.530,12.383 C10.045,12.817 9.501,13.304 8.932,13.823 C8.365,13.305 7.823,12.818 7.332,12.379 C5.821,11.025 4.515,9.857 3.647,8.754 C2.770,7.644 2.379,6.662 2.379,5.570 C2.379,4.540 2.706,3.599 3.300,2.923 C3.877,2.266 4.668,1.905 5.529,1.905 Z"/>
                                                    </svg>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Product Details start -->







    <!-- Product Description tab start -->
    <section class="e-pdtab-wrap mb-20">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="e-pdtab-inner">
                        <ul class="nav nav-pills e-pdtab-tabs" role="tablist">
                            <li>
                                <a class="active" data-toggle="pill" href="#descrtiption" role="tab"
                                   aria-controls="descrtiption" aria-selected="true">توضیحات </a>
                            </li>
                            <li>
                                <a data-toggle="pill" href="#addi_info" role="tab" aria-controls="addi_info"
                                   aria-selected="false">نظرات</a>
                            </li>
                            <li>
                                <a data-toggle="pill" href="#review" role="tab" aria-controls="review"
                                   aria-selected="false"> گذاشتن نظر</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="descrtiption" role="tabpanel">
                                <div class="tab-content-inner">
                                    <p class="mb-20">{{ details.description | safe }} </p>

                                </div>
                            </div>
                            <div class="tab-pane fade" id="addi_info" role="tabpanel">
                                <div class="tab-content-inner">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <ul class="pdtab-addinfo">
                                                {% for foo in comments %}
                                                    <li><p> {{ foo.body | safe }}</p></li>
                                                {% endfor %}
                                            </ul>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="review" role="tabpanel">
                                <div class="tab-content-inner">

                                    <h2 class="pdtab-rev-stitle">نظر خود را وارد کنید .</h2>
                                    <form action="{% url 'product:comment_create' details.id %}" method="post">
                                        {% csrf_token %}
                                        <div class="row">
                                            {#                                      <div class="col-md-6">#}
                                            {#                                        <div class="e-form-field mb-30">#}
                                            {#                                          <input class="e-field-inner" type="text" placeholder="نام شما">#}
                                            {#                                        </div>#}
                                            {#                                      </div>#}
                                            {#                                      <div class="col-md-6">#}
                                            {#                                        <div class="e-form-field mb-30">#}
                                            {#                                          <input class="e-field-inner" type="email" placeholder="ایمیل">#}
                                            {#                                        </div>#}
                                            {#                                      </div>#}
                                            <div class="col-12 ">
                                                <div class="e-form-field mb-30">

                                                    {{ comment_form.media }}
                                                    {{ comment_form.body }}
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="e-form-field">
                                                    <button type="submit" class="e-btn">ارسال</button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <script>

        document.addEventListener('DOMContentLoaded', function () {

            let sizeInputs = document.getElementsByName('selected_size');


            sizeInputs.forEach(function (input) {
                input.addEventListener('click', function () {

                    let selectedSize = input.value;
                    console.log('Selected Size: ' + selectedSize);
                    let sizeColorDictElement = document.getElementById('size_color_dict');

                    let sizeColorDictContent = sizeColorDictElement.textContent.trim();


                    let sizeColorDictContentCleaned = sizeColorDictContent.replace(/'/g, '"').replace(/ /g, '');


                    let sizeColorDictJSON = JSON.parse(sizeColorDictContentCleaned);


                    console.log(sizeColorDictJSON);

                    console.log(sizeColorDictJSON[selectedSize])

                    ul_color = document.getElementById('color')
                    ul_color.innerHTML = '';
                    let colors = sizeColorDictJSON[selectedSize];

                    for (let i = 0; i < colors.length; i++) {
                        let color = colors[i];

                        let li = document.createElement('li');
                        li.style.width = '50px';
                        li.style.height = '50px';
                        li.style.padding = '5px';
                        {#li.setAttribute('onclick', 'selectColor(this, "' + color + '")');#}
                        li.setAttribute('onclick', 'selectColor(this, "' + color + '")');

                        let div = document.createElement('div');
                        div.style.width = '90%';
                        div.style.height = '90%';
                        div.style.borderRadius = '5px';
                        div.style.boxSizing = 'border-box';
                        div.style.margin = 'auto';
                        div.style.backgroundColor = color;

                        li.appendChild(div);
                        ul_color.appendChild(li);

                    }

                });
            });
        });


        let selected_color = null;

        function selectColor(element, color) {

            let liElements = document.querySelectorAll('.ib-list-right ul li');
            liElements.forEach(function (li) {
                li.style.border = 'none';
            });
            element.style.border = '2px solid black';
            selectedColor = color;
            selected_color = color
            console.log(selected_color)
        }


        document.addEventListener('DOMContentLoaded', function () {
            const quantityInput = document.querySelector('.quantity_input');
            const quantityMinus = document.querySelector('.quantity-minus');
            const quantityPlus = document.querySelector('.quantity-plus');


            const minValue = 1;
            const maxValue = 4;


            quantityMinus.addEventListener('click', function () {
                let value = parseInt(quantityInput.value);
                if (value > minValue) {
                    quantityInput.value = value - 1;
                } else {
                    quantityInput.value = minValue;
                }
            });


            quantityPlus.addEventListener('click', function () {
                let value = parseInt(quantityInput.value);
                if (value < maxValue) {
                    quantityInput.value = value + 1;
                } else {
                    quantityInput.value = maxValue;
                }
            });


        });


        function addToCart() {
            let selectedColor = selected_color;
            if (!selectedColor) {
                alert("لطفاً رنگ  محصول را انتخاب کنید.");
                return;
            }
            console.log(selectedColor)
            let quantity = document.querySelector('.quantity_input').value;
            console.log(quantity)

            let selectedSizeInput = document.querySelector('input[name="selected_size"]:checked');
            if (!selectedSizeInput) {
                alert("لطفاً سایز محصول را انتخاب کنید.");
                return;
            }
            let selectedSize = selectedSizeInput.value;

            console.log('a')



            let itemId = "{{ details.id }}";
            let imageSrc = "{{ details.image.url }}";
            let name = "{{ details.name  }}"
            let originalPrice = "{{ details.price }}";
            {#let discountedPrice = "{{ details.calculate_discounted_price }}";#}
            let discountedPrice;
            {#let a = "{{ details.discount  }}"#}
            {#console.log(typeof a)#}
            {#console.log(a)#}

            if ("{{ details.discount }}" !== "None") {
                discountedPrice = parseInt("{{ details.calculate_discounted_price }}");
                console.log('zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz')
            } else {

                discountedPrice = 0;
            }


            let cart = JSON.parse(sessionStorage.getItem("cart")) || {};
            cart[itemId] = {
                "name": name,
                "size": selectedSize,
                "color": selectedColor,
                "quantity": quantity,
                "imageSrc": imageSrc,
                "originalPrice": originalPrice,
                "discountedPrice": discountedPrice
            };

            sessionStorage.setItem("cart", JSON.stringify(cart));
            alert("محصول با موفقیت به سبد خرید اضافه شد.");
        }


        {#    function getCookie(cookieName) {#}
        {#        let name = cookieName + "=";#}
        {#        let decodedCookie = decodeURIComponent(document.cookie);#}
        {#        let cookieArray = decodedCookie.split(';');#}
        {#        for(let i = 0; i < cookieArray.length; i++) {#}
        {#            let cookie = cookieArray[i].trim();#}
        {#            if (cookie.indexOf(name) == 0) {#}
        {#                return cookie.substring(name.length, cookie.length);#}
        {#            }#}
        {#        }#}
        {#        return "";#}

        {##}
        {##}
        {#function setCookie(cookieName, cookieValue, expireDays) {#}
        {#    let d = new Date();#}
        {#    d.setTime(d.getTime() + (expireDays * 24 * 60 * 60 * 1000));#}
        {#    let expires = "expires="+d.toUTCString();#}
        {#    document.cookie = cookieName + "=" + cookieValue + ";" + expires + ";path=/";#}

        {##}
        {#    function addToCart() {#}
        {#        let selectedSize = document.querySelector('input[name="selected_size"]:checked').value;#}
        {#        console.log(selectedSize)#}
        {#        let selectedColor = document.querySelector('.na-color-skin li[selectedColor]').getAttribute('selectedColor');#}
        {#        console.log(selectedColor)#}
        {##}
        {#        let itemId = "{{ details.id }}";#}
        {#        console.log(itemId)#}
        {##}
        {#        let quantity = document.querySelector('.quantity').value;#}
        {#        console.log(quantity)#}
        {##}
        {#        let cart = JSON.parse(getCookie("cart")) || {};#}
        {#         cart[itemId] = {#}
        {#        "size": selectedSize,#}
        {#        "color": selectedColor,#}
        {#        "quantity": quantity#}
        {#    };#}
        {##}
        {##}
        {#    setCookie("cart", JSON.stringify(cart), 1);#}
        {##}

    </script>



{% endblock content %}